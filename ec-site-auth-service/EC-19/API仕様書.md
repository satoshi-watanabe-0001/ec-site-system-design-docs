# API仕様書 - ユーザー退会処理API

## ドキュメント情報
- **プロジェクト**: EC-Site認証サービス
- **チケット**: EC-19
- **作成日**: 2025-11-11
- **バージョン**: 1.0.0
- **ステータス**: 実装完了

## 1. 概要

### 1.1 目的
ユーザーが自身のアカウントを退会できる機能を提供する。誤操作からの復旧を可能にするため、30日間の猶予期間を設けた多段階削除プロセスを採用する。

### 1.2 スコープ
- **対象**: 自己退会のみ（ユーザーが自分自身のアカウントを退会）
- **対象外**: 管理者による他ユーザーの退会（将来のPBIで対応予定）

## 2. エンドポイント仕様

### 2.1 ユーザー退会API

#### 基本情報
- **エンドポイント**: `POST /api/v1/users/{id}/withdraw`
- **説明**: 指定されたユーザーIDのアカウントを退会処理する
- **認証**: JWT Bearer Token（必須）
- **認可**: 自己退会のみ許可（{id}とトークンのユーザーIDが一致必須）

#### リクエスト

**パスパラメータ**
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | UUID | ✅ | 退会対象のユーザーID |

**ヘッダー**
| ヘッダー | 値 | 必須 | 説明 |
|---------|-----|------|------|
| Authorization | Bearer {token} | ✅ | JWT認証トークン |
| Content-Type | application/json | ✅ | リクエストボディの形式 |

**リクエストボディ**
```json
{
  "reason": "サービスを利用しなくなったため"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| reason | string | ❌ | 最大1000文字 | 退会理由（任意） |

**リクエスト例**
```bash
curl -X POST https://api.example.com/api/v1/users/550e8400-e29b-41d4-a716-446655440000/withdraw \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "reason": "サービスを利用しなくなったため"
  }'
```

#### レスポンス

**成功レスポンス（202 Accepted）**
```json
{
  "status": "success",
  "message": "退会処理を受け付けました",
  "data": {
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "userStatus": "PENDING_DELETION",
    "scheduledDeletionAt": "2025-12-11T09:45:51Z",
    "gracePeriodDays": 30
  }
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| status | string | 処理結果（"success"） |
| message | string | ユーザー向けメッセージ |
| data.userId | UUID | 退会処理されたユーザーID |
| data.userStatus | string | 更新後のユーザーステータス（"PENDING_DELETION"） |
| data.scheduledDeletionAt | ISO 8601 | 削除予定日時（UTC） |
| data.gracePeriodDays | integer | 猶予期間日数 |

**エラーレスポンス**

| HTTPステータス | エラーコード | 説明 | レスポンス例 |
|---------------|-------------|------|-------------|
| 400 Bad Request | INVALID_REQUEST | リクエストパラメータが不正 | `{"status": "error", "message": "退会理由は1000文字以内で入力してください"}` |
| 401 Unauthorized | UNAUTHORIZED | 認証トークンが無効または期限切れ | `{"status": "error", "message": "認証が必要です"}` |
| 403 Forbidden | FORBIDDEN | 他人のアカウントを退会しようとした | `{"status": "error", "message": "自分自身のアカウントのみ退会できます"}` |
| 404 Not Found | USER_NOT_FOUND | 指定されたユーザーIDが存在しない | `{"status": "error", "message": "ユーザーが見つかりません"}` |
| 409 Conflict | ALREADY_PENDING_DELETION | 既に退会処理中 | `{"status": "error", "message": "既に退会処理が進行中です"}` |
| 409 Conflict | ALREADY_DELETED | 既に削除済み | `{"status": "error", "message": "このアカウントは既に削除されています"}` |
| 500 Internal Server Error | INTERNAL_ERROR | サーバー内部エラー | `{"status": "error", "message": "サーバーエラーが発生しました"}` |

## 3. 認証・認可

### 3.1 認証方式
- **方式**: JWT Bearer Token
- **トークン取得**: `/api/v1/auth/login` エンドポイントでログイン後に取得
- **トークン有効期限**: アクセストークン15分、リフレッシュトークン7日間

### 3.2 認可ルール
- **自己退会のみ許可**: パスパラメータの`{id}`とJWTトークンに含まれるユーザーIDが一致する場合のみ処理を許可
- **不一致の場合**: 403 Forbiddenを返却

### 3.3 CSRF対策
- **方針**: JWT Bearer Token認証を使用するステートレスAPIのため、CSRF保護は不要
- **SecurityConfig**: APIエンドポイント（`/api/**`）に対してCSRF保護を無効化

## 4. データモデル

### 4.1 Userエンティティ拡張

**追加フィールド**
| フィールド | 型 | NULL許可 | 説明 |
|-----------|-----|---------|------|
| deletion_scheduled_at | TIMESTAMP | ✅ | 削除予定日時（UTC） |
| deleted_at | TIMESTAMP | ✅ | 実際の削除日時（UTC） |
| withdrawal_reason | TEXT | ✅ | 退会理由 |

**UserStatus enum拡張**
- 既存: `PENDING`, `ACTIVE`, `INACTIVE`, `SUSPENDED`
- 追加: `PENDING_DELETION`, `DELETED`

### 4.2 状態遷移

```
ACTIVE → PENDING_DELETION → DELETED
  ↑            ↓
  └────────────┘
   (猶予期間内の復旧)
```

## 5. ビジネスロジック

### 5.1 退会処理フロー

1. **認証・認可チェック**
   - JWTトークンの検証
   - パスパラメータのユーザーIDとトークンのユーザーIDの一致確認

2. **ユーザー状態確認**
   - ユーザーの存在確認
   - 既に`PENDING_DELETION`または`DELETED`でないことを確認

3. **退会処理実行**
   - ユーザーステータスを`PENDING_DELETION`に変更
   - `deletion_scheduled_at`に現在時刻 + 30日を設定
   - `withdrawal_reason`に退会理由を保存（任意）

4. **通知送信**
   - 退会確認メールを送信（現在はログ出力のみ）

5. **レスポンス返却**
   - 202 Acceptedで非同期処理の受付を通知

### 5.2 猶予期間

- **期間**: 30日間（設定可能）
- **設定場所**: `application.yml`の`withdrawal.grace-days`
- **デフォルト値**: 30日
- **目的**: 誤操作からの復旧を可能にする

### 5.3 最終削除処理（将来実装）

猶予期間終了後の最終削除処理は、別のバッチ処理で実装予定:
1. `deletion_scheduled_at`が現在時刻を過ぎたユーザーを検索
2. ステータスを`DELETED`に変更
3. `deleted_at`に現在時刻を設定
4. 個人情報を匿名化（メールアドレス、名前など）

## 6. セキュリティ考慮事項

### 6.1 認可の厳格化
- 自己退会のみ許可（他人のアカウントは退会不可）
- パスパラメータとトークンのユーザーID一致を必須チェック

### 6.2 トークン無効化
- **現状**: 退会後も既存JWTトークンは有効期限まで使用可能
- **リスク**: 退会後15分間はAPIアクセスが可能
- **緩和策**: アクセストークンの有効期限を短く設定（15分）
- **将来対応**: トークンバージョン管理またはブラックリスト方式の導入

### 6.3 監査ログ
- 退会処理の実行ログを記録
- ユーザーID、実行日時、退会理由を保存

## 7. エラーハンドリング

### 7.1 バリデーションエラー
- 退会理由が1000文字を超える場合: 400 Bad Request
- ユーザーIDがUUID形式でない場合: 404 Not Found（Spring MVCの自動処理）

### 7.2 ビジネスロジックエラー
- ユーザーが存在しない: 404 Not Found
- 既に退会処理中: 409 Conflict
- 既に削除済み: 409 Conflict
- 他人のアカウント: 403 Forbidden

### 7.3 システムエラー
- データベース接続エラー: 500 Internal Server Error
- 予期しない例外: 500 Internal Server Error

## 8. 非機能要件

### 8.1 パフォーマンス
- **レスポンスタイム**: 平均200ms以下
- **同時実行**: 100リクエスト/秒まで対応

### 8.2 可用性
- **稼働率**: 99.9%以上
- **ダウンタイム**: 計画メンテナンス時のみ

### 8.3 スケーラビリティ
- 水平スケーリング対応（ステートレス設計）

## 9. テスト観点

### 9.1 正常系
- ✅ 有効なトークンと自己IDで退会成功
- ✅ 退会理由なしで退会成功
- ✅ ステータスが`PENDING_DELETION`に変更
- ✅ `deletion_scheduled_at`が30日後に設定

### 9.2 異常系
- ✅ 認証トークンなし → 401
- ✅ 他人のID指定 → 403
- ✅ 存在しないユーザーID → 404
- ✅ 既に`PENDING_DELETION` → 409
- ✅ 既に`DELETED` → 409
- ✅ 退会理由が1000文字超 → 400

## 10. 既知の制約・非対応項目

### 10.1 現在のスコープ外
- `/api/v1/users/me/withdraw` エンドポイント（自己参照）
- 管理者による他ユーザーの退会
- 猶予期間内の復旧機能
- 退会後のデータエクスポート（GDPR対応）
- クロスサービスのデータ削除連携

### 10.2 将来のPBIで対応予定
- 猶予期間終了後の最終削除バッチ処理
- トークン無効化の高度化（tokenVersion方式）
- 削除証明書の発行
- 監査ログの専用テーブル化

## 11. 関連ドキュメント

- [データベース設計書](./データベース設計書.md)
- [アーキテクチャ設計書](./アーキテクチャ設計書.md)
- [セキュリティ設計書](./セキュリティ設計書.md)
- [システム構成図](./システム構成図.md)

## 12. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|---------|--------|
| 2025-11-11 | 1.0.0 | 初版作成 | Devin |

---

**作成者**: Devin  
**承認者**: （レビュー待ち）  
**最終更新**: 2025-11-11
